### 2023 年 05/27(土)

## 取り組んだ課題

スッキリ SQL 入門

トランザクションの章とテーブル作成の章

## わかったこと

### トランザクション

安全で確実なデータ操作とデータ管理ほど重要なことはありません。めちゃ大事！

**1 つ以上の SQL 文を一つの塊**として扱う様指示することができます。

### トランザクションの中断

トラブルがあってクエリ文の途中で中断してしまう場合がある。

**一部だけが実行されることはあってはならない、途中で分割不可能なもの**

残高を減らすと残高を増やす UPDATE 文は必ず両方とも実行されていなければならない

この塊をトランザクションにすることで,よきせぬトラブルが起きても

ロールバックを行い,DB には保存されない。

---

データが書き換えられるとそのデータは**仮のものとして管理**

トランザクションが終了して初めて**仮の書き換え**を全て確定させる

この確定行為のことを**コミット**という！

逆によきせぬ異常が発生して中断した場合は仮の書き換えはなかったことにできる。

そのなかったことにする行為を**ロールバック**と言います！

---

トランザクションの指定方法

**BEGIN**

開始の指示。この指示以降の SQL 文を 1 つのトランザクションとする

**COMMIT**

終了の指示。この指示までを１つのトランザクションとし変更を確定する。

**ROLLBACK**

終了の指示。この指示までを 1 つのトランザクションとし、変更の取り消しをする。

### トランザクションの分離

ほぼ同時にクエリ文を実行したときに起こる。

### ３つの代表的な副作用

**ダーティーリード**

**反復不能読み取り**

**ファントムリード**

慎重にクエリ文(作成、更新、削除など)を実行したいときは

BEGIN から始めた方がいいと思いました。

### ロック

副作用を起こさないためには**ロック**という仕組みがある

同時にトランザクションを実行させないために片方にロックをかけてもう片方の

処理が終わったら鍵が解除される。

**要するに、相手のトランザクションが完了するまで自分は待たされる**

ロックはトランザクション、即ち BIGIN からクエリ文を書けば自動でできる。(手動方法もある)

---

### ロックのありがたさについて自分で例を考えてみた。

EC サイトであと一品で売り切れる場合、同時に A さんと B さんがその商品を購入しました。

在庫が 1 つしかない場合、どちらか 1 人だけが購入できるようにしなければならない

ここでロックが大活躍！

A さん が購入処理を開始すると、

データベースシステムは在庫データに対してロックをかけます。

これにより、B さん が同時に購入処理を開始しようとしても、

ロックが解除されるまで在庫データにアクセスできない状態になります。

A さん の購入処理が完了し、在庫が減らされた後でロックが解除されると、

B さん は在庫がないことが確認でき、売り切れと表示される。

### もしロックがなかったら。

顧客関連：買ったのに、後から在庫がないことに気づきます

クレームにつながりかねませんし、信用も下がります。

DB 関連:購入できた A さんにも被害に繋がる可能性あり、

データベースでの競合状態やデータの破損に繋がる。

データの整合性と一貫性を保つためロックは、とても大事だとわかりました!

---

ただし！！！

全てにトランザクション(ロック)をやたら無意味に使うとパフォーマンスが落ちてしまう

どの程度厳密にトランザクションを分離するかを

**トランザクション分離レベル**として指定することができる。

```sql
BEGIN;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
クエリ文;
n個目のクエリ分;
COMMIT;
```

こんな感じでトランザクションを作れます。

`SET TRANSACTION ISOLATION LEVEL SERIALIZABLE`これはレベルがあって最も安全なレベル

ですが低速になりパフォーマンスが悪くなります。

スッキリ SQL の本からの情報で大体`READ COMMITTED`を選べばいいらしいです！

ダーティーリードは発生しないレベルです！！

### デットロック

ロックの副作用の一つ

たくさんのトランザクションを実行されるとまれに

デットロックと呼ばれる状態になる。

永久に処理が止まってしまうことがあるので DBMS は**デッドロックを**

**自動的に解決する仕組み**が備わっている

### デットロックを予防する方法

- トランザクションの時間を短くする
- 同じ順番でロックする様にする

### テーブル作成

命令文には複数の言語がある

- DML: データ操作言語 => 検索したりレコード作成したり、更新したり、削除したり(四大命令)
- TCL: トランザクション制約言語 => トランザクションの開始や終了を命令
- DDL: データ定義言語 => テーブル作成や削除制約やデータ型などの命令
- DCL: データ抑制言語 => 大体は root の人が設定する。DML と DDL の利用に関する許可や禁止を設定する命令

---

ALTER TABLE 文を使うとカラム追加と削除ができる!!!

## 制約

制約をつけることでミスを防ぐことができる

制約は`CREATE TABLE`でテーブルを作る際に列定義の後ろに指定することが可能！

### よく使う基本的な 3 種類の制約

- NOT NULL: NULL 禁止
- CHECK: CHECK(カラム名 比較演算子 OO)で条件式が真となるような値だけ格納
- UNIQUE: 重複禁止

## 次やること

スッキリ SQL 入門のテーブル作成の章の続きから

## 感じたこと

トランザクションの仕組みが凄すぎて感動しました。

DB 関連にとどまらず、こうやってどんどんエンジニアの世界は常に進化していくんだなと思いました！

今日も一日お疲れ様でした！

## 勉強時間

Today: 5h

Total: 319h
